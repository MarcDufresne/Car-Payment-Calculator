<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quebec Car Finance Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom slider styles */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        input[type=range]:hover {
            opacity: 1;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        /* Style for placeholder text */
        ::placeholder {
            color: #9ca3af;
            opacity: 1; 
        }
        .tab-active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 lg:p-8" x-data="carCalculator()">

    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 mb-12">
        
        <!-- Header -->
        <div class="flex items-center justify-start mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500 mr-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2zM2 16a1 1 0 112 0 1 1 0 01-2 0z" clip-rule="evenodd" />
            </svg>
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Quebec Car Finance Calculator</h1>
                <p class="text-sm sm:text-base text-gray-500 mt-1">Estimate your payments and total costs with Quebec-specific tax rules.</p>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button @click="activeTab = 'payment'" 
                        :class="activeTab === 'payment' ? 'tab-active' : 'text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="tab-button whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm">Payment Calculator</button>
                <button @click="activeTab = 'budget'" 
                        :class="activeTab === 'budget' ? 'tab-active' : 'text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="tab-button whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm">Budget Calculator</button>
            </nav>
        </div>

        <div x-show="activeTab === 'payment'">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Left Side: Inputs -->
                <div class="lg:col-span-2 space-y-6">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">1. Your Numbers</h2>
                    
                    <!-- Input Group: Purchase Details -->
                    <div>
                        <label for="vehiclePrice" class="block text-sm font-medium text-gray-600 mb-1">Vehicle Price</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" x-model.number="vehiclePrice" placeholder="e.g., 45000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="fees" class="block text-sm font-medium text-gray-600 mb-1">Fees (Freight, PDI, AC Tax, etc.)</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" x-model.number="fees" placeholder="e.g., 2000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Input Group: Deductions -->
                    <h3 class="text-lg font-semibold text-gray-700 pt-4 border-t">Deductions</h3>
                     <div>
                        <label for="downPayment" class="block text-sm font-medium text-gray-600 mb-1">Down Payment</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" x-model.number="downPayment" placeholder="e.g., 5000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="tradeIn" class="block text-sm font-medium text-gray-600 mb-1">Trade-In Value</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" x-model.number="tradeIn" placeholder="e.g., 10000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="fedIncentive" class="block text-sm font-medium text-gray-600 mb-1">Federal EV Incentive</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" x-model.number="fedIncentive" placeholder="e.g., 5000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="provIncentive" class="block text-sm font-medium text-gray-600 mb-1">Provincial EV Incentive</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" x-model.number="provIncentive" placeholder="e.g., 7000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Input Group: Loan Terms -->
                    <h3 class="text-lg font-semibold text-gray-700 pt-4 border-t">Loan Details</h3>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="interestRate" class="block text-sm font-medium text-gray-600">Interest Rate</label>
                            <span class="text-sm font-semibold text-blue-600"><input type="number" x-model.number="interestRate" step="0.01" class="w-16 text-right border-0 focus:ring-0 p-0 bg-transparent">%</span>
                        </div>
                        <input type="range" x-model.number="interestRate" min="0" max="20" step="0.01">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="loanTerm" class="block text-sm font-medium text-gray-600">Loan Term</label>
                            <span class="text-sm font-semibold text-blue-600"><input type="number" x-model.number="loanTerm" step="12" class="w-16 text-right border-0 focus:ring-0 p-0 bg-transparent"> months</span>
                        </div>
                        <input type="range" x-model.number="loanTerm" min="12" max="96" step="12">
                    </div>
                </div>

                <!-- Right Side: Results -->
                <div class="lg:col-span-3">
                    <!-- Payment Schedule -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">2. Estimated Payment Schedule</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            <div class="bg-white p-4 rounded-lg border border-blue-200">
                                <p class="text-sm text-gray-500">Monthly</p>
                                <p x-text="formatCurrency(calculations.monthlyPayment)" class="text-2xl font-bold text-blue-600 my-2">$0.00</p>
                                <p class="text-xs text-gray-500">Interest: <span x-text="formatCurrency(calculations.monthlyInterest)" class="font-medium text-gray-700">$0.00</span></p>
                                <p class="text-xs text-gray-500">Cost: <span x-text="formatCurrency(calculations.monthlyCost)" class="font-medium text-gray-700">$0.00</span></p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <p class="text-sm text-gray-500">Bi-Weekly</p>
                                <p x-text="formatCurrency(calculations.biweeklyPayment)" class="text-2xl font-bold text-gray-800 my-2">$0.00</p>
                                <p class="text-xs text-gray-500">Interest: <span x-text="formatCurrency(calculations.biweeklyInterest)" class="font-medium text-gray-700">$0.00</span></p>
                                <p class="text-xs text-gray-500">Cost: <span x-text="formatCurrency(calculations.biweeklyCost)" class="font-medium text-gray-700">$0.00</span></p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <p class="text-sm text-gray-500">Weekly</p>
                                <p x-text="formatCurrency(calculations.weeklyPayment)" class="text-2xl font-bold text-gray-800 my-2">$0.00</p>
                                <p class="text-xs text-gray-500">Interest: <span x-text="formatCurrency(calculations.weeklyInterest)" class="font-medium text-gray-700">$0.00</span></p>
                                <p class="text-xs text-gray-500">Cost: <span x-text="formatCurrency(calculations.weeklyCost)" class="font-medium text-gray-700">$0.00</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Calculation Breakdown -->
                    <div class="bg-gray-50 rounded-xl p-6 mt-8">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">3. Calculation Breakdown</h2>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center"><span class="text-gray-600">Vehicle Price + Fees</span><span x-text="formatCurrency(calculations.subtotal)" class="font-medium text-gray-800">$0.00</span></div>
                            <div class="flex justify-between items-center border-t pt-3"><span class="text-gray-600">Taxable Amount (after Trade-in)</span><span x-text="formatCurrency(calculations.taxableAmount)" class="font-medium text-gray-800">$0.00</span></div>
                            <div class="flex justify-between items-center pl-4"><span class="text-gray-500">GST (5.0%)</span><span x-text="formatCurrency(calculations.gst)" class="font-medium text-gray-600">$0.00</span></div>
                            <div class="flex justify-between items-center pl-4"><span class="text-gray-500">QST (9.975%)</span><span x-text="formatCurrency(calculations.qst)" class="font-medium text-gray-600">$0.00</span></div>
                            <div class="flex justify-between items-center border-t pt-3"><span class="text-gray-600">Total Price with Taxes</span><span x-text="formatCurrency(calculations.totalWithTaxes)" class="font-medium text-gray-800">$0.00</span></div>
                            <div class="flex justify-between items-center border-t pt-3"><span class="text-gray-600">Total Deductions</span><span x-text="'-' + formatCurrency(calculations.totalDeductions)" class="font-medium text-red-500">-$0.00</span></div>
                            <div class="flex justify-between items-center text-lg bg-blue-100 p-3 rounded-lg mt-3"><span class="font-semibold text-blue-800">Amount to be Financed</span><span x-text="formatCurrency(calculations.amountToFinance)" class="font-bold text-blue-800">$0.00</span></div>
                        </div>
                    </div>

                    <!-- Payment Matrix -->
                    <div class="bg-gray-50 rounded-xl p-6 mt-8">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">4. Payment Matrix</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Interest Rates (%)</label>
                                <div class="grid grid-cols-3 sm:grid-cols-4 gap-x-4 gap-y-2">
                                    <template x-for="rate in matrixRates" :key="rate">
                                        <div class="flex items-center">
                                            <input :id="'rate-' + rate" type="checkbox" :value="rate" x-model="selectedRates" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <label :for="'rate-' + rate" class="ml-2 block text-sm text-gray-900" x-text="rate + '%'"></label>
                                        </div>
                                    </template>
                                    <div class="flex items-center col-span-2 sm:col-span-4">
                                        <input type="checkbox" x-model="useCustomRate" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label class="ml-2 block text-sm text-gray-900">Custom:</label>
                                        <input type="number" x-model.number="customRate" step="0.01" x-show="useCustomRate" class="ml-2 w-24 px-2 py-1 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 8.25">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Loan Terms (Months)</label>
                                <div class="grid grid-cols-4 gap-x-4 gap-y-2">
                                    <template x-for="term in matrixTerms" :key="term">
                                        <div class="flex items-center">
                                            <input :id="'term-' + term" type="checkbox" :value="term" x-model="selectedTerms" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <label :for="'term-' + term" class="ml-2 block text-sm text-gray-900" x-text="term"></label>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 rounded-l-lg">Term</th>
                                        <template x-for="(rate, index) in getActiveRates()" :key="rate">
                                            <th scope="col" class="px-4 py-3 text-center" :class="index === getActiveRates().length - 1 ? 'rounded-r-lg' : ''" x-text="rate.toFixed(2) + '%'"></th>
                                        </template>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="term in selectedTerms.sort((a, b) => a - b)" :key="term">
                                        <tr class="border-b">
                                            <th scope="row" class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap" x-text="term + ' mo'"></th>
                                            <template x-for="rate in getActiveRates()" :key="rate">
                                                <td class="p-2 text-center" x-html="getMatrixCell(term, rate)"></td>
                                            </template>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div x-show="activeTab === 'budget'">
            <div class="max-w-md mx-auto space-y-6">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Budget Calculator</h2>
                <p class="text-sm text-gray-600">Start with your desired monthly payment to see what you can afford.</p>
                
                <div class="bg-gray-50 border rounded-lg p-4 space-y-2">
                    <h3 class="text-sm font-semibold text-gray-800">Using These Values (from main tab):</h3>
                    <div class="text-xs text-gray-600 grid grid-cols-2 gap-x-4 gap-y-1">
                        <div><span class="font-medium text-gray-900">Fees:</span> <span x-text="formatCurrency(fees)"></span></div>
                        <div><span class="font-medium text-gray-900">Trade-In:</span> <span x-text="formatCurrency(tradeIn)"></span></div>
                        <div><span class="font-medium text-gray-900">Incentives:</span> <span x-text="formatCurrency(fedIncentive + provIncentive)"></span></div>
                        <div><span class="font-medium text-gray-900">Interest Rate:</span> <span x-text="interestRate.toFixed(2) + '%'"></span></div>
                        <div><span class="font-medium text-gray-900">Loan Term:</span> <span x-text="loanTerm + ' months'"></span></div>
                        <div x-show="reverseMode === 'maxPrice'"><span class="font-medium text-gray-900">Down Payment:</span> <span x-text="formatCurrency(downPayment)"></span></div>
                        <div x-show="reverseMode === 'minDP'"><span class="font-medium text-gray-900">Vehicle Price:</span> <span x-text="formatCurrency(vehiclePrice)"></span></div>
                    </div>
                </div>

                <div>
                    <label for="desiredPayment" class="block text-sm font-medium text-gray-600 mb-1">Desired Monthly Payment</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                        <input type="number" x-model.number="desiredPayment" placeholder="e.g., 500" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="space-y-2">
                     <label class="block text-sm font-medium text-gray-600">Calculation Mode</label>
                     <div class="flex space-x-4">
                        <div class="flex items-center">
                            <input x-model="reverseMode" value="maxPrice" type="radio" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label class="ml-2 block text-sm text-gray-900">Find Max Vehicle Price</label>
                        </div>
                        <div class="flex items-center">
                            <input x-model="reverseMode" value="minDP" type="radio" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label class="ml-2 block text-sm text-gray-900">Find Min Down Payment</label>
                        </div>
                     </div>
                </div>
                <div x-html="budgetResult" class="bg-blue-50 p-4 rounded-lg text-center">
                   <!-- Result will be injected here -->
                </div>
            </div>
        </div>

    </div>

    <script>
        function carCalculator() {
            return {
                // Constants
                GST_RATE: 0.05,
                QST_RATE: 0.09975,
                get TOTAL_TAX_RATE() { return this.GST_RATE + this.QST_RATE; },
                matrixTerms: [12, 24, 36, 48, 60, 72, 84, 96],
                matrixRates: [3.99, 4.99, 5.99, 6.99, 7.99],
                
                // State
                activeTab: 'payment',
                vehiclePrice: 0,
                fees: 0,
                downPayment: 0,
                tradeIn: 0,
                fedIncentive: 0,
                provIncentive: 0,
                interestRate: 4.99,
                loanTerm: 72,
                desiredPayment: 0,
                reverseMode: 'maxPrice',
                selectedRates: [4.99, 5.99, 6.99],
                selectedTerms: [48, 60, 72],
                useCustomRate: false,
                customRate: 0,
                
                init() {
                    this.loadFromStorage();
                    // Note: $watch is not needed with our simple reactive system
                    // Changes will trigger updates automatically through event listeners
                },
                
                // Helper functions
                parseNum(val) {
                    return parseFloat(val) || 0;
                },
                
                formatCurrency(num) {
                    return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }).format(num);
                },
                
                formatCurrencyShort(num) {
                    return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', maximumFractionDigits: 0 }).format(num);
                },
                
                calculatePayment(principal, rate, numberOfPayments) {
                    if (principal <= 0) return 0;
                    if (rate === 0 || numberOfPayments === 0) return principal / (numberOfPayments || 1);
                    const factor = Math.pow(1 + rate, numberOfPayments);
                    return principal * (rate * factor) / (factor - 1);
                },
                
                calculatePrincipal(monthlyPayment, rate, numberOfPayments) {
                    if (monthlyPayment <= 0) return 0;
                    if (rate === 0) return monthlyPayment * numberOfPayments;
                    const factor = Math.pow(1 + rate, numberOfPayments);
                    return monthlyPayment * (factor - 1) / (rate * factor);
                },
                
                // Computed properties
                get calculations() {
                    const vehiclePrice = this.parseNum(this.vehiclePrice);
                    const fees = this.parseNum(this.fees);
                    const downPayment = this.parseNum(this.downPayment);
                    const tradeIn = this.parseNum(this.tradeIn);
                    const fedIncentive = this.parseNum(this.fedIncentive);
                    const provIncentive = this.parseNum(this.provIncentive);
                    const interestRate = this.parseNum(this.interestRate) / 100;
                    const loanTermMonths = this.parseNum(this.loanTerm);
                    
                    const subtotal = vehiclePrice + fees;
                    const taxableAmount = Math.max(0, subtotal - tradeIn);
                    const gst = taxableAmount * this.GST_RATE;
                    const qst = taxableAmount * this.QST_RATE;
                    const totalWithTaxes = subtotal + gst + qst;
                    const totalDeductions = downPayment + tradeIn + fedIncentive + provIncentive;
                    const amountToFinance = Math.max(0, totalWithTaxes - totalDeductions);

                    const monthlyRate = interestRate / 12;
                    const monthlyPayment = this.calculatePayment(amountToFinance, monthlyRate, loanTermMonths);
                    const totalMonthlyPaid = monthlyPayment * loanTermMonths;
                    const monthlyInterest = totalMonthlyPaid > 0 ? totalMonthlyPaid - amountToFinance : 0;
                    const monthlyCost = totalMonthlyPaid + downPayment + tradeIn;

                    const biweeklyPeriods = (loanTermMonths / 12) * 26;
                    const biweeklyRate = interestRate / 26;
                    const biweeklyPayment = this.calculatePayment(amountToFinance, biweeklyRate, biweeklyPeriods);
                    const totalBiweeklyPaid = biweeklyPayment * biweeklyPeriods;
                    const biweeklyInterest = totalBiweeklyPaid > 0 ? totalBiweeklyPaid - amountToFinance : 0;
                    const biweeklyCost = totalBiweeklyPaid + downPayment + tradeIn;

                    const weeklyPeriods = (loanTermMonths / 12) * 52;
                    const weeklyRate = interestRate / 52;
                    const weeklyPayment = this.calculatePayment(amountToFinance, weeklyRate, weeklyPeriods);
                    const totalWeeklyPaid = weeklyPayment * weeklyPeriods;
                    const weeklyInterest = totalWeeklyPaid > 0 ? totalWeeklyPaid - amountToFinance : 0;
                    const weeklyCost = totalWeeklyPaid + downPayment + tradeIn;
                    
                    return {
                        subtotal, taxableAmount, gst, qst, totalWithTaxes, totalDeductions, amountToFinance,
                        monthlyPayment, monthlyInterest, monthlyCost,
                        biweeklyPayment, biweeklyInterest, biweeklyCost,
                        weeklyPayment, weeklyInterest, weeklyCost
                    };
                },
                
                get budgetResult() {
                    const desiredPayment = this.parseNum(this.desiredPayment);
                    const interestRate = this.parseNum(this.interestRate) / 100;
                    const loanTermMonths = this.parseNum(this.loanTerm);
                    const monthlyRate = interestRate / 12;

                    const fees = this.parseNum(this.fees);
                    const tradeIn = this.parseNum(this.tradeIn);
                    const fedIncentive = this.parseNum(this.fedIncentive);
                    const provIncentive = this.parseNum(this.provIncentive);
                    const downPayment = this.parseNum(this.downPayment);
                    const vehiclePrice = this.parseNum(this.vehiclePrice);

                    if (this.reverseMode === 'maxPrice') {
                        const maxFinanced = this.calculatePrincipal(desiredPayment, monthlyRate, loanTermMonths);
                        if (maxFinanced > 0) {
                            const totalDeductions = downPayment + tradeIn + fedIncentive + provIncentive;
                            const totalValue = maxFinanced + totalDeductions;
                            const subtotal = (totalValue + tradeIn * this.TOTAL_TAX_RATE) / (1 + this.TOTAL_TAX_RATE);
                            const maxPrice = subtotal - fees;
                            return `<p class="text-sm text-gray-700">Max. Affordable Vehicle Price:</p><p class="text-2xl font-bold text-blue-600">${this.formatCurrency(Math.max(0, maxPrice))}</p>`;
                        } else {
                            return `<p class="text-sm text-gray-700">Enter a desired payment.</p>`;
                        }
                    } else {
                        if (vehiclePrice > 0) {
                            const subtotal = vehiclePrice + fees;
                            const taxableAmount = Math.max(0, subtotal - tradeIn);
                            const totalWithTaxes = subtotal + (taxableAmount * this.TOTAL_TAX_RATE);
                            const requiredFinanced = this.calculatePrincipal(desiredPayment, monthlyRate, loanTermMonths);
                            const requiredTotalDeductions = totalWithTaxes - requiredFinanced;
                            const minDownPayment = requiredTotalDeductions - (tradeIn + fedIncentive + provIncentive);
                            return `<p class="text-sm text-gray-700">Min. Required Down Payment:</p><p class="text-2xl font-bold text-blue-600">${this.formatCurrency(Math.max(0, minDownPayment))}</p>`;
                        } else {
                            return `<p class="text-sm text-gray-700">Enter a vehicle price on the main tab.</p>`;
                        }
                    }
                },
                
                getActiveRates() {
                    const rates = [...this.selectedRates];
                    if (this.useCustomRate && this.customRate > 0) {
                        rates.push(this.customRate);
                    }
                    return rates.sort((a, b) => a - b);
                },
                
                getMatrixCell(term, rate) {
                    const amountToFinance = this.calculations.amountToFinance;
                    const downPayment = this.parseNum(this.downPayment);
                    const tradeIn = this.parseNum(this.tradeIn);
                    
                    if (amountToFinance <= 0) return '';
                    
                    const monthlyRate = (rate / 100) / 12;
                    const payment = this.calculatePayment(amountToFinance, monthlyRate, term);
                    const totalPaid = payment * term;
                    const totalInterest = totalPaid > 0 ? totalPaid - amountToFinance : 0;
                    const totalCost = totalPaid + downPayment + tradeIn;
                    
                    // Calculate min/max for styling
                    const activeRates = this.getActiveRates();
                    const activeTerms = this.selectedTerms.sort((a, b) => a - b);
                    
                    let minPayment = Infinity, maxPayment = -Infinity;
                    let minInterest = Infinity, maxInterest = -Infinity;
                    let minCost = Infinity, maxCost = -Infinity;
                    
                    activeTerms.forEach(t => {
                        activeRates.forEach(r => {
                            const mRate = (r / 100) / 12;
                            const p = this.calculatePayment(amountToFinance, mRate, t);
                            const tPaid = p * t;
                            const tInterest = tPaid > 0 ? tPaid - amountToFinance : 0;
                            const tCost = tPaid + downPayment + tradeIn;
                            
                            minPayment = Math.min(minPayment, p);
                            maxPayment = Math.max(maxPayment, p);
                            minInterest = Math.min(minInterest, tInterest);
                            maxInterest = Math.max(maxInterest, tInterest);
                            minCost = Math.min(minCost, tCost);
                            maxCost = Math.max(maxCost, tCost);
                        });
                    });
                    
                    let paymentStyle = '', interestStyle = '', costStyle = '';
                    if (payment === minPayment) paymentStyle = 'text-green-600 font-bold';
                    if (payment === maxPayment) paymentStyle = 'text-red-600 font-bold';
                    if (totalInterest === minInterest) interestStyle = 'text-green-600 font-bold';
                    if (totalInterest === maxInterest) interestStyle = 'text-red-600 font-bold';
                    if (totalCost === minCost) costStyle = 'text-green-600 font-bold';
                    if (totalCost === maxCost) costStyle = 'text-red-600 font-bold';

                    const paymentIcon = payment === minPayment ? '<span class="text-green-500">▼</span>' : payment === maxPayment ? '<span class="text-red-500">▲</span>' : '';
                    const interestIcon = totalInterest === minInterest ? '<span class="text-green-500">▼</span>' : totalInterest === maxInterest ? '<span class="text-red-500">▲</span>' : '';
                    const costIcon = totalCost === minCost ? '<span class="text-green-500">▼</span>' : totalCost === maxCost ? '<span class="text-red-500">▲</span>' : '';

                    return `<div class="font-semibold text-gray-800 ${paymentStyle}">${this.formatCurrency(payment)} ${paymentIcon}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                <div class="${interestStyle}">Int: ${this.formatCurrencyShort(totalInterest)} ${interestIcon}</div>
                                <div class="${costStyle}">Cost: ${this.formatCurrencyShort(totalCost)} ${costIcon}</div>
                            </div>`;
                },
                
                // Storage functions
                saveToStorage() {
                    try {
                        const data = {
                            vehiclePrice: this.vehiclePrice,
                            fees: this.fees,
                            downPayment: this.downPayment,
                            tradeIn: this.tradeIn,
                            fedIncentive: this.fedIncentive,
                            provIncentive: this.provIncentive,
                            interestRate: this.interestRate,
                            loanTerm: this.loanTerm,
                            desiredPayment: this.desiredPayment,
                            reverseMode: this.reverseMode
                        };
                        localStorage.setItem('quebecCarCalculatorCache', JSON.stringify(data));
                    } catch (e) {
                        console.error("Could not save data to local storage:", e);
                    }
                },
                
                loadFromStorage() {
                    try {
                        const data = localStorage.getItem('quebecCarCalculatorCache');
                        if (data) {
                            const parsed = JSON.parse(data);
                            this.vehiclePrice = parsed.vehiclePrice || 0;
                            this.fees = parsed.fees || 0;
                            this.downPayment = parsed.downPayment || 0;
                            this.tradeIn = parsed.tradeIn || 0;
                            this.fedIncentive = parsed.fedIncentive || 0;
                            this.provIncentive = parsed.provIncentive || 0;
                            this.interestRate = parsed.interestRate || 4.99;
                            this.loanTerm = parsed.loanTerm || 72;
                            this.desiredPayment = parsed.desiredPayment || 0;
                            this.reverseMode = parsed.reverseMode || 'maxPrice';
                        }
                    } catch (e) {
                        console.error("Could not load data from local storage:", e);
                        localStorage.removeItem('quebecCarCalculatorCache');
                    }
                }
            }
        }
    </script>

</body>
</html>
