<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quebec Car Finance Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom slider styles */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        input[type=range]:hover {
            opacity: 1;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        /* Style for placeholder text */
        ::placeholder {
            color: #9ca3af;
            opacity: 1; 
        }
        .tab-active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 mb-12">
        
        <!-- Header -->
        <div class="flex items-center justify-start mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500 mr-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2zM2 16a1 1 0 112 0 1 1 0 01-2 0z" clip-rule="evenodd" />
            </svg>
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Quebec Car Finance Calculator</h1>
                <p class="text-sm sm:text-base text-gray-500 mt-1">Estimate your payments and total costs with Quebec-specific tax rules.</p>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="tab-payment" class="tab-button whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm tab-active">Payment Calculator</button>
                <button id="tab-budget" class="tab-button whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Budget Calculator</button>
            </nav>
        </div>

        <div id="tab-content-payment">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Left Side: Inputs -->
                <div class="lg:col-span-2 space-y-6">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">1. Your Numbers</h2>
                    
                    <!-- Input Group: Purchase Details -->
                    <div>
                        <label for="vehiclePrice" class="block text-sm font-medium text-gray-600 mb-1">Vehicle Price</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" id="vehiclePrice" placeholder="e.g., 45000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="fees" class="block text-sm font-medium text-gray-600 mb-1">Fees (Freight, PDI, AC Tax, etc.)</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" id="fees" placeholder="e.g., 2000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Input Group: Deductions -->
                    <h3 class="text-lg font-semibold text-gray-700 pt-4 border-t">Deductions</h3>
                     <div>
                        <label for="downPayment" class="block text-sm font-medium text-gray-600 mb-1">Down Payment</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" id="downPayment" placeholder="e.g., 5000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="tradeIn" class="block text-sm font-medium text-gray-600 mb-1">Trade-In Value</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" id="tradeIn" placeholder="e.g., 10000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="fedIncentive" class="block text-sm font-medium text-gray-600 mb-1">Federal EV Incentive</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" id="fedIncentive" placeholder="e.g., 5000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="provIncentive" class="block text-sm font-medium text-gray-600 mb-1">Provincial EV Incentive</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input type="number" id="provIncentive" placeholder="e.g., 7000" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Input Group: Loan Terms -->
                    <h3 class="text-lg font-semibold text-gray-700 pt-4 border-t">Loan Details</h3>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="interestRate" class="block text-sm font-medium text-gray-600">Interest Rate</label>
                            <span class="text-sm font-semibold text-blue-600"><input type="number" id="interestRate" value="4.99" step="0.01" class="w-16 text-right border-0 focus:ring-0 p-0 bg-transparent">%</span>
                        </div>
                        <input type="range" id="interestRateSlider" min="0" max="20" step="0.01" value="4.99">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="loanTerm" class="block text-sm font-medium text-gray-600">Loan Term</label>
                            <span class="text-sm font-semibold text-blue-600"><input type="number" id="loanTerm" value="72" step="12" class="w-16 text-right border-0 focus:ring-0 p-0 bg-transparent"> months</span>
                        </div>
                        <input type="range" id="loanTermSlider" min="12" max="96" step="12" value="72">
                    </div>
                </div>

                <!-- Right Side: Results -->
                <div class="lg:col-span-3">
                    <!-- Payment Schedule -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">2. Estimated Payment Schedule</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            <div class="bg-white p-4 rounded-lg border border-blue-200">
                                <p class="text-sm text-gray-500">Monthly</p>
                                <p id="monthlyPayment" class="text-2xl font-bold text-blue-600 my-2">$0.00</p>
                                <p class="text-xs text-gray-500">Interest: <span id="monthlyInterest" class="font-medium text-gray-700">$0.00</span></p>
                                <p class="text-xs text-gray-500">Cost: <span id="monthlyCost" class="font-medium text-gray-700">$0.00</span></p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <p class="text-sm text-gray-500">Bi-Weekly</p>
                                <p id="biweeklyPayment" class="text-2xl font-bold text-gray-800 my-2">$0.00</p>
                                <p class="text-xs text-gray-500">Interest: <span id="biweeklyInterest" class="font-medium text-gray-700">$0.00</span></p>
                                <p class="text-xs text-gray-500">Cost: <span id="biweeklyCost" class="font-medium text-gray-700">$0.00</span></p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <p class="text-sm text-gray-500">Weekly</p>
                                <p id="weeklyPayment" class="text-2xl font-bold text-gray-800 my-2">$0.00</p>
                                <p class="text-xs text-gray-500">Interest: <span id="weeklyInterest" class="font-medium text-gray-700">$0.00</span></p>
                                <p class="text-xs text-gray-500">Cost: <span id="weeklyCost" class="font-medium text-gray-700">$0.00</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Calculation Breakdown -->
                    <div class="bg-gray-50 rounded-xl p-6 mt-8">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">3. Calculation Breakdown</h2>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center"><span class="text-gray-600">Vehicle Price + Fees</span><span id="breakdownSubtotal" class="font-medium text-gray-800">$0.00</span></div>
                            <div class="flex justify-between items-center border-t pt-3"><span class="text-gray-600">Taxable Amount (after Trade-in)</span><span id="breakdownTaxable" class="font-medium text-gray-800">$0.00</span></div>
                            <div class="flex justify-between items-center pl-4"><span class="text-gray-500">GST (5.0%)</span><span id="breakdownGst" class="font-medium text-gray-600">$0.00</span></div>
                            <div class="flex justify-between items-center pl-4"><span class="text-gray-500">QST (9.975%)</span><span id="breakdownQst" class="font-medium text-gray-600">$0.00</span></div>
                            <div class="flex justify-between items-center border-t pt-3"><span class="text-gray-600">Total Price with Taxes</span><span id="breakdownTotalWithTaxes" class="font-medium text-gray-800">$0.00</span></div>
                            <div class="flex justify-between items-center border-t pt-3"><span class="text-gray-600">Total Deductions</span><span id="breakdownDeductions" class="font-medium text-red-500">-$0.00</span></div>
                            <div class="flex justify-between items-center text-lg bg-blue-100 p-3 rounded-lg mt-3"><span class="font-semibold text-blue-800">Amount to be Financed</span><span id="breakdownTotalFinanced" class="font-bold text-blue-800">$0.00</span></div>
                        </div>
                    </div>

                    <!-- Payment Matrix -->
                    <div class="bg-gray-50 rounded-xl p-6 mt-8">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">4. Payment Matrix</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Interest Rates (%)</label>
                                <div id="matrix-rates-container" class="grid grid-cols-3 sm:grid-cols-4 gap-x-4 gap-y-2"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Loan Terms (Months)</label>
                                <div id="matrix-terms-container" class="grid grid-cols-4 gap-x-4 gap-y-2"></div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-200" id="matrix-head"></thead>
                                <tbody id="matrix-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="tab-content-budget" class="hidden">
            <div class="max-w-md mx-auto space-y-6">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Budget Calculator</h2>
                <p class="text-sm text-gray-600">Start with your desired monthly payment to see what you can afford.</p>
                
                <div class="bg-gray-50 border rounded-lg p-4 space-y-2">
                    <h3 class="text-sm font-semibold text-gray-800">Using These Values (from main tab):</h3>
                    <div id="budget-summary" class="text-xs text-gray-600 grid grid-cols-2 gap-x-4 gap-y-1">
                        <!-- Summary injected here -->
                    </div>
                </div>

                <div>
                    <label for="desiredPayment" class="block text-sm font-medium text-gray-600 mb-1">Desired Monthly Payment</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                        <input type="number" id="desiredPayment" placeholder="e.g., 500" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="space-y-2">
                     <label class="block text-sm font-medium text-gray-600">Calculation Mode</label>
                     <div class="flex space-x-4">
                        <div class="flex items-center">
                            <input id="modeMaxPrice" name="reverseMode" type="radio" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="modeMaxPrice" class="ml-2 block text-sm text-gray-900">Find Max Vehicle Price</label>
                        </div>
                        <div class="flex items-center">
                            <input id="modeMinDP" name="reverseMode" type="radio" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="modeMinDP" class="ml-2 block text-sm text-gray-900">Find Min Down Payment</label>
                        </div>
                     </div>
                </div>
                <div id="reverseResultContainer" class="bg-blue-50 p-4 rounded-lg text-center">
                   <!-- Result will be injected here -->
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS ---
            const GST_RATE = 0.05;
            const QST_RATE = 0.09975;
            const TOTAL_TAX_RATE = GST_RATE + QST_RATE;
            const MATRIX_TERMS = [12, 24, 36, 48, 60, 72, 84, 96];
            const DEFAULT_TERMS = [48, 60, 72];
            const MATRIX_RATES = [3.99, 4.99, 5.99, 6.99, 7.99];
            const DEFAULT_RATES = [4.99, 5.99, 6.99];
            const CACHE_KEY = 'quebecCarCalculatorCache';
            const CACHED_INPUT_IDS = [
                'vehiclePrice', 'fees', 'downPayment', 'tradeIn', 'fedIncentive', 'provIncentive',
                'interestRate', 'loanTerm', 'desiredPayment'
            ];

            // --- DOM ELEMENT REFERENCES ---
            const elementIds = [
                ...CACHED_INPUT_IDS, 'interestRateSlider', 'loanTermSlider',
                'monthlyPayment', 'biweeklyPayment', 'weeklyPayment',
                'monthlyInterest', 'biweeklyInterest', 'weeklyInterest',
                'monthlyCost', 'biweeklyCost', 'weeklyCost',
                'breakdownSubtotal', 'breakdownTaxable', 'breakdownGst', 'breakdownQst',
                'breakdownTotalWithTaxes', 'breakdownDeductions', 'breakdownTotalFinanced',
                'matrix-rates-container', 'matrix-terms-container', 'matrix-head', 'matrix-body',
                'modeMaxPrice', 'modeMinDP', 'reverseResultContainer', 'budget-summary',
                'tab-payment', 'tab-budget', 'tab-content-payment', 'tab-content-budget'
            ];
            const elements = {};
            elementIds.forEach(id => elements[id] = document.getElementById(id));

            // --- LOCAL STORAGE FUNCTIONS (ROBUST) ---
            function saveDataToCache() {
                try {
                    const dataToCache = {};
                    CACHED_INPUT_IDS.forEach(id => {
                        dataToCache[id] = elements[id].value;
                    });
                    dataToCache.reverseMode = elements.modeMinDP.checked ? 'minDP' : 'maxPrice';
                    localStorage.setItem(CACHE_KEY, JSON.stringify(dataToCache));
                } catch (e) {
                    console.error("Could not save data to local storage:", e);
                }
            }

            function loadDataFromCache() {
                try {
                    const cachedData = localStorage.getItem(CACHE_KEY);
                    if (cachedData) {
                        const data = JSON.parse(cachedData);
                        CACHED_INPUT_IDS.forEach(id => {
                            if (data[id] !== undefined) {
                                elements[id].value = data[id];
                            }
                        });
                        if (data.reverseMode === 'minDP') {
                            elements.modeMinDP.checked = true;
                        } else {
                            elements.modeMaxPrice.checked = true;
                        }
                        // Sync sliders
                        elements.interestRateSlider.value = elements.interestRate.value;
                        elements.loanTermSlider.value = elements.loanTerm.value;
                    }
                } catch (e) {
                    console.error("Could not load data from local storage. Starting fresh.", e);
                    localStorage.removeItem(CACHE_KEY);
                }
            }

            // --- INITIAL UI SETUP ---
            function setupCheckboxes() {
                const termsContainer = elements['matrix-terms-container'];
                MATRIX_TERMS.forEach(term => {
                    const isChecked = DEFAULT_TERMS.includes(term);
                    termsContainer.innerHTML += `<div class="flex items-center"><input id="term-${term}" type="checkbox" value="${term}" class="matrix-term-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isChecked ? 'checked' : ''}><label for="term-${term}" class="ml-2 block text-sm text-gray-900">${term}</label></div>`;
                });

                const ratesContainer = elements['matrix-rates-container'];
                MATRIX_RATES.forEach(rate => {
                    const isChecked = DEFAULT_RATES.includes(rate);
                    ratesContainer.innerHTML += `<div class="flex items-center"><input id="rate-${rate}" type="checkbox" value="${rate}" class="matrix-rate-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isChecked ? 'checked' : ''}><label for="rate-${rate}" class="ml-2 block text-sm text-gray-900">${rate}%</label></div>`;
                });
                ratesContainer.innerHTML += `<div class="flex items-center col-span-2 sm:col-span-4"><input id="rate-custom-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="rate-custom-checkbox" class="ml-2 block text-sm text-gray-900">Custom:</label><input type="number" id="rate-custom-value" step="0.01" class="ml-2 w-24 px-2 py-1 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500 hidden" placeholder="e.g., 8.25"></div>`;
            }

            // --- HELPER FUNCTIONS ---
            const parseNum = (val) => parseFloat(val) || 0;
            const formatCurrency = (num) => new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }).format(num);
            const formatCurrencyShort = (num) => new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', maximumFractionDigits: 0 }).format(num);
            const calculatePayment = (principal, rate, numberOfPayments) => {
                if (principal <= 0) return 0;
                if (rate === 0 || numberOfPayments === 0) return principal / (numberOfPayments || 1);
                const factor = Math.pow(1 + rate, numberOfPayments);
                return principal * (rate * factor) / (factor - 1);
            };
            const calculatePrincipal = (monthlyPayment, rate, numberOfPayments) => {
                if (monthlyPayment <= 0) return 0;
                if (rate === 0) return monthlyPayment * numberOfPayments;
                const factor = Math.pow(1 + rate, numberOfPayments);
                return monthlyPayment * (factor - 1) / (rate * factor);
            };

            // --- DECOUPLED CALCULATION FUNCTIONS ---

            function calculatePayments() {
                const vehiclePrice = parseNum(elements.vehiclePrice.value);
                const fees = parseNum(elements.fees.value);
                const downPayment = parseNum(elements.downPayment.value);
                const tradeIn = parseNum(elements.tradeIn.value);
                const fedIncentive = parseNum(elements.fedIncentive.value);
                const provIncentive = parseNum(elements.provIncentive.value);
                const interestRate = parseNum(elements.interestRate.value) / 100;
                const loanTermMonths = parseNum(elements.loanTerm.value);
                
                const subtotal = vehiclePrice + fees;
                const taxableAmount = Math.max(0, subtotal - tradeIn);
                const gst = taxableAmount * GST_RATE;
                const qst = taxableAmount * QST_RATE;
                const totalWithTaxes = subtotal + gst + qst;
                const totalDeductions = downPayment + tradeIn + fedIncentive + provIncentive;
                const amountToFinance = Math.max(0, totalWithTaxes - totalDeductions);

                const monthlyRate = interestRate / 12;
                const monthlyPayment = calculatePayment(amountToFinance, monthlyRate, loanTermMonths);
                const totalMonthlyPaid = monthlyPayment * loanTermMonths;
                const totalMonthlyInterest = totalMonthlyPaid > 0 ? totalMonthlyPaid - amountToFinance : 0;
                const totalMonthlyCost = totalMonthlyPaid + downPayment + tradeIn;

                const biweeklyPeriods = (loanTermMonths / 12) * 26;
                const biweeklyRate = interestRate / 26;
                const biweeklyPayment = calculatePayment(amountToFinance, biweeklyRate, biweeklyPeriods);
                const totalBiweeklyPaid = biweeklyPayment * biweeklyPeriods;
                const totalBiweeklyInterest = totalBiweeklyPaid > 0 ? totalBiweeklyPaid - amountToFinance : 0;
                const totalBiweeklyCost = totalBiweeklyPaid + downPayment + tradeIn;

                const weeklyPeriods = (loanTermMonths / 12) * 52;
                const weeklyRate = interestRate / 52;
                const weeklyPayment = calculatePayment(amountToFinance, weeklyRate, weeklyPeriods);
                const totalWeeklyPaid = weeklyPayment * weeklyPeriods;
                const totalWeeklyInterest = totalWeeklyPaid > 0 ? totalWeeklyPaid - amountToFinance : 0;
                const totalWeeklyCost = totalWeeklyPaid + downPayment + tradeIn;

                elements.monthlyPayment.textContent = formatCurrency(monthlyPayment);
                elements.biweeklyPayment.textContent = formatCurrency(biweeklyPayment);
                elements.weeklyPayment.textContent = formatCurrency(weeklyPayment);
                elements.monthlyInterest.textContent = formatCurrency(totalMonthlyInterest);
                elements.biweeklyInterest.textContent = formatCurrency(totalBiweeklyInterest);
                elements.weeklyInterest.textContent = formatCurrency(totalWeeklyInterest);
                elements.monthlyCost.textContent = formatCurrency(totalMonthlyCost);
                elements.biweeklyCost.textContent = formatCurrency(totalBiweeklyCost);
                elements.weeklyCost.textContent = formatCurrency(totalWeeklyCost);
                elements.breakdownSubtotal.textContent = formatCurrency(subtotal);
                elements.breakdownTaxable.textContent = formatCurrency(taxableAmount);
                elements.breakdownGst.textContent = formatCurrency(gst);
                elements.breakdownQst.textContent = formatCurrency(qst);
                elements.breakdownTotalWithTaxes.textContent = formatCurrency(totalWithTaxes);
                elements.breakdownDeductions.textContent = `-${formatCurrency(totalDeductions)}`;
                elements.breakdownTotalFinanced.textContent = formatCurrency(amountToFinance);
                
                updatePaymentMatrix(amountToFinance, downPayment, tradeIn);
            }

            function calculateBudget() {
                const desiredPayment = parseNum(elements.desiredPayment.value);
                const interestRate = parseNum(elements.interestRate.value) / 100;
                const loanTermMonths = parseNum(elements.loanTerm.value);
                const monthlyRate = interestRate / 12;

                const fees = parseNum(elements.fees.value);
                const tradeIn = parseNum(elements.tradeIn.value);
                const fedIncentive = parseNum(elements.fedIncentive.value);
                const provIncentive = parseNum(elements.provIncentive.value);
                const downPayment = parseNum(elements.downPayment.value);
                const vehiclePrice = parseNum(elements.vehiclePrice.value);

                let resultHTML = '';

                if (elements.modeMaxPrice.checked) {
                    const maxFinanced = calculatePrincipal(desiredPayment, monthlyRate, loanTermMonths);
                    if (maxFinanced > 0) {
                        const totalDeductions = downPayment + tradeIn + fedIncentive + provIncentive;
                        const totalValue = maxFinanced + totalDeductions;
                        const subtotal = (totalValue + tradeIn * TOTAL_TAX_RATE) / (1 + TOTAL_TAX_RATE);
                        const maxPrice = subtotal - fees;
                        resultHTML = `<p class="text-sm text-gray-700">Max. Affordable Vehicle Price:</p><p class="text-2xl font-bold text-blue-600">${formatCurrency(Math.max(0, maxPrice))}</p>`;
                    } else {
                        resultHTML = `<p class="text-sm text-gray-700">Enter a desired payment.</p>`;
                    }
                } else {
                    if (vehiclePrice > 0) {
                        const subtotal = vehiclePrice + fees;
                        const taxableAmount = Math.max(0, subtotal - tradeIn);
                        const totalWithTaxes = subtotal + (taxableAmount * TOTAL_TAX_RATE);
                        const requiredFinanced = calculatePrincipal(desiredPayment, monthlyRate, loanTermMonths);
                        const requiredTotalDeductions = totalWithTaxes - requiredFinanced;
                        const minDownPayment = requiredTotalDeductions - (tradeIn + fedIncentive + provIncentive);
                        resultHTML = `<p class="text-sm text-gray-700">Min. Required Down Payment:</p><p class="text-2xl font-bold text-blue-600">${formatCurrency(Math.max(0, minDownPayment))}</p>`;
                    } else {
                        resultHTML = `<p class="text-sm text-gray-700">Enter a vehicle price on the main tab.</p>`;
                    }
                }
                elements.reverseResultContainer.innerHTML = resultHTML;
            }
            
            function updateBudgetSummary() {
                const summary = {
                    "Fees": formatCurrency(parseNum(elements.fees.value)),
                    "Trade-In": formatCurrency(parseNum(elements.tradeIn.value)),
                    "Incentives": formatCurrency(parseNum(elements.fedIncentive.value) + parseNum(elements.provIncentive.value)),
                    "Interest Rate": `${parseNum(elements.interestRate.value).toFixed(2)}%`,
                    "Loan Term": `${parseNum(elements.loanTerm.value)} months`,
                };
                 if (elements.modeMaxPrice.checked) {
                    summary["Down Payment"] = formatCurrency(parseNum(elements.downPayment.value));
                } else {
                    summary["Vehicle Price"] = formatCurrency(parseNum(elements.vehiclePrice.value));
                }
                let summaryHTML = '';
                for (const [key, value] of Object.entries(summary)) {
                    summaryHTML += `<div><span class="font-medium text-gray-900">${key}:</span> ${value}</div>`;
                }
                elements['budget-summary'].innerHTML = summaryHTML;
            }

            function updatePaymentMatrix(amountToFinance, downPayment, tradeIn) {
                const rates = [];
                document.querySelectorAll('.matrix-rate-checkbox:checked').forEach(cb => rates.push(parseFloat(cb.value)));
                const customRateCb = document.getElementById('rate-custom-checkbox');
                if (customRateCb.checked) {
                    const customVal = parseNum(document.getElementById('rate-custom-value').value);
                    if (customVal > 0) rates.push(customVal);
                }
                rates.sort((a, b) => a - b);

                const terms = [];
                document.querySelectorAll('.matrix-term-checkbox:checked').forEach(cb => terms.push(parseInt(cb.value)));
                terms.sort((a, b) => a - b);

                elements['matrix-head'].innerHTML = '';
                elements['matrix-body'].innerHTML = '';
                if (rates.length === 0 || terms.length === 0 || amountToFinance <= 0) return;

                let minPayment = Infinity, maxPayment = -Infinity;
                let minInterest = Infinity, maxInterest = -Infinity;
                let minCost = Infinity, maxCost = -Infinity;
                const matrixData = [];

                terms.forEach(term => {
                    const row = [];
                    rates.forEach(rate => {
                        const monthlyRate = (rate / 100) / 12;
                        const payment = calculatePayment(amountToFinance, monthlyRate, term);
                        const totalPaid = payment * term;
                        const totalInterest = totalPaid > 0 ? totalPaid - amountToFinance : 0;
                        const totalCost = totalPaid + downPayment + tradeIn;
                        
                        minPayment = Math.min(minPayment, payment);
                        maxPayment = Math.max(maxPayment, payment);
                        minInterest = Math.min(minInterest, totalInterest);
                        maxInterest = Math.max(maxInterest, totalInterest);
                        minCost = Math.min(minCost, totalCost);
                        maxCost = Math.max(maxCost, totalCost);

                        row.push({ payment, totalInterest, totalCost });
                    });
                    matrixData.push(row);
                });
                
                let headerHTML = '<tr><th scope="col" class="px-4 py-3 rounded-l-lg">Term</th>';
                rates.forEach((rate, i) => {
                    headerHTML += `<th scope="col" class="px-4 py-3 text-center ${i === rates.length - 1 ? 'rounded-r-lg' : ''}">${rate.toFixed(2)}%</th>`;
                });
                headerHTML += '</tr>';
                elements['matrix-head'].innerHTML = headerHTML;

                let bodyHTML = '';
                matrixData.forEach((row, termIndex) => {
                    const term = terms[termIndex];
                    bodyHTML += `<tr class="border-b"><th scope="row" class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">${term} mo</th>`;
                    row.forEach(cellData => {
                        let paymentStyle = '', interestStyle = '', costStyle = '';
                        if (cellData.payment === minPayment) paymentStyle = 'text-green-600 font-bold';
                        if (cellData.payment === maxPayment) paymentStyle = 'text-red-600 font-bold';
                        if (cellData.totalInterest === minInterest) interestStyle = 'text-green-600 font-bold';
                        if (cellData.totalInterest === maxInterest) interestStyle = 'text-red-600 font-bold';
                        if (cellData.totalCost === minCost) costStyle = 'text-green-600 font-bold';
                        if (cellData.totalCost === maxCost) costStyle = 'text-red-600 font-bold';

                        const paymentIcon = cellData.payment === minPayment ? '<span class="text-green-500">▼</span>' : cellData.payment === maxPayment ? '<span class="text-red-500">▲</span>' : '';
                        const interestIcon = cellData.totalInterest === minInterest ? '<span class="text-green-500">▼</span>' : cellData.totalInterest === maxInterest ? '<span class="text-red-500">▲</span>' : '';
                        const costIcon = cellData.totalCost === minCost ? '<span class="text-green-500">▼</span>' : cellData.totalCost === maxCost ? '<span class="text-red-500">▲</span>' : '';

                        bodyHTML += `<td class="p-2 text-center">
                            <div class="font-semibold text-gray-800 ${paymentStyle}">${formatCurrency(cellData.payment)} ${paymentIcon}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                <div class="${interestStyle}">Int: ${formatCurrencyShort(cellData.totalInterest)} ${interestIcon}</div>
                                <div class="${costStyle}">Cost: ${formatCurrencyShort(cellData.totalCost)} ${costIcon}</div>
                            </div>
                        </td>`;
                    });
                    bodyHTML += '</tr>';
                });
                elements['matrix-body'].innerHTML = bodyHTML;
            }

            // --- MASTER UPDATE FUNCTION ---
            function updateUI() {
                saveDataToCache();
                calculatePayments();
                calculateBudget();
                updateBudgetSummary();
            }

            // --- EVENT LISTENERS ---
            function addEventListeners() {
                const inputsToListen = [
                    'vehiclePrice', 'fees', 'downPayment', 'tradeIn', 'fedIncentive', 'provIncentive',
                    'interestRate', 'loanTerm', 'interestRateSlider', 'loanTermSlider',
                    'desiredPayment'
                ];
                inputsToListen.forEach(id => elements[id].addEventListener('input', updateUI));
                
                document.querySelectorAll('.matrix-term-checkbox, .matrix-rate-checkbox, #rate-custom-checkbox, #rate-custom-value, input[name="reverseMode"]').forEach(el => {
                    el.addEventListener('input', updateUI);
                });

                document.getElementById('rate-custom-checkbox').addEventListener('change', (e) => {
                    document.getElementById('rate-custom-value').classList.toggle('hidden', !e.target.checked);
                });
                
                elements.interestRateSlider.addEventListener('input', () => elements.interestRate.value = elements.interestRateSlider.value);
                elements.interestRate.addEventListener('input', () => elements.interestRateSlider.value = elements.interestRate.value);
                elements.loanTermSlider.addEventListener('input', () => elements.loanTerm.value = elements.loanTermSlider.value);
                elements.loanTerm.addEventListener('input', () => elements.loanTermSlider.value = elements.loanTerm.value);
                
                elements['tab-payment'].addEventListener('click', () => switchTab('payment'));
                elements['tab-budget'].addEventListener('click', () => switchTab('budget'));
            }
            
            function switchTab(tabName) {
                const isPaymentTab = tabName === 'payment';
                elements['tab-content-payment'].classList.toggle('hidden', !isPaymentTab);
                elements['tab-content-budget'].classList.toggle('hidden', isPaymentTab);
                elements['tab-payment'].classList.toggle('tab-active', isPaymentTab);
                elements['tab-budget'].classList.toggle('tab-active', !isPaymentTab);
                elements['tab-payment'].classList.toggle('text-gray-500', !isPaymentTab);
                elements['tab-budget'].classList.toggle('text-gray-500', isPaymentTab);
                updateUI(); 
            }
            
            // --- INITIALIZATION ---
            setupCheckboxes();
            loadDataFromCache();
            addEventListeners();
            updateUI();
        });
    </script>

</body>
</html>
